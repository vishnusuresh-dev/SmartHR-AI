<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Path - {{ employee.full_name }}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PDF Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #eceef5ff 0%, #b3c2f2ff 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2em;
            font-weight: bold;
        }
        .employee-details h1 {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 5px;
        }
        .employee-details p {
            color: #666;
            margin: 3px 0;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transition: transform 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }
        .header-actions {
            display: flex;
            gap: 10px;
        }
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }
        .card h2 {
            font-size: 1.4em;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .loading {
            text-align: center;
            padding: 60px;
            color: #666;
        }
        .skill-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin: 15px 0;
        }
        .skill-badge {
            padding: 12px 15px;
            background: #f7fafc;
            border-radius: 8px;
            font-weight: 600;
            color: #333;
        }
        .skill-badge.gap {
            background: #fee;
            color: #d63031;
            border-left: 4px solid #d63031;
        }
        .learning-content {
            line-height: 1.8;
            color: #444;
        }
        .learning-content h3 {
            margin-top: 25px;
            margin-bottom: 12px;
            color: #667eea;
            font-size: 1.2em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }
        .learning-content h4 {
            margin-top: 18px;
            margin-bottom: 10px;
            color: #764ba2;
            font-size: 1.05em;
        }
        .learning-content ul {
            margin-left: 25px;
            margin-bottom: 15px;
        }
        .learning-content li {
            margin: 8px 0;
            line-height: 1.6;
        }
        .learning-content p {
            margin-bottom: 15px;
        }
        .learning-content strong {
            color: #333;
        }
        .project-list {
            display: grid;
            gap: 12px;
        }
        .project-item {
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .project-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        .project-desc {
            font-size: 0.9em;
            color: #666;
        }
        .timeline-item {
            padding: 12px;
            background: #f0f4ff;
            border-left: 3px solid #667eea;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .resource-box {
            background: #f9fafb;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <div class="avatar-large">{{ employee.full_name[0] }}</div>
                <div class="employee-details">
                    <h1>{{ employee.full_name }}</h1>
                    <p><i class="fas fa-id-card"></i> {{ employee.employee_id }}</p>
                    <p><i class="fas fa-briefcase"></i> {{ employee.job_title or 'N/A' }} • {{ employee.department or 'N/A' }}</p>
                </div>
            </div>
            <div class="header-actions">
                <button id="downloadBtn" class="btn btn-success" style="display: none;" onclick="downloadPDF()">
                    <i class="fas fa-download"></i> Download PDF
                </button>
                <a href="/learning-paths" class="btn">
                    <i class="fas fa-arrow-left"></i> Back
                </a>
            </div>
        </div>

        <div id="loadingState" class="card loading">
            <i class="fas fa-spinner fa-spin" style="font-size: 2em; color: #667eea;"></i>
            <p style="margin-top: 15px;">Generating personalized learning path...</p>
        </div>

        <div id="contentArea" style="display: none;">
            <!-- Projects Card -->
            <div class="card">
                <h2><i class="fas fa-project-diagram" style="color: #667eea;"></i> Active Projects</h2>
                <div id="projectsList" class="project-list"></div>
            </div>

            <!-- Skills Overview -->
            <div class="card">
                <h2><i class="fas fa-chart-bar" style="color: #48bb78;"></i> Skills Overview</h2>
                
                <h3 style="margin-top: 15px; color: #666; font-size: 1em;">Current Skills</h3>
                <div id="currentSkills" class="skill-grid"></div>
                
                <h3 style="margin-top: 25px; color: #666; font-size: 1em;">Skills to Learn</h3>
                <div id="skillGaps" class="skill-grid"></div>
            </div>

            <!-- Learning Path -->
            <div class="card">
                <h2><i class="fas fa-route" style="color: #ed8936;"></i> Personalized Learning Path</h2>
                <div id="learningPath" class="learning-content"></div>
            </div>
        </div>
    </div>

    <script>
        const employeeId = "{{ employee.employee_id }}";
        const employeeName = "{{ employee.full_name }}";
        const employeeTitle = "{{ employee.job_title or 'N/A' }}";
        const employeeDept = "{{ employee.department or 'N/A' }}";
        
        let learningPathData = null;

        async function loadLearningPath() {
            try {
                const response = await fetch(`/api/learning-path/${employeeId}/generate`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    if (data.skill_gaps.length === 0) {
                        document.getElementById('loadingState').innerHTML = `
                            <i class="fas fa-check-circle" style="font-size: 3em; color: #48bb78;"></i>
                            <h2 style="margin-top: 15px;">No Skill Gaps!</h2>
                            <p>${employeeName} has all required skills for current projects.</p>
                        `;
                        return;
                    }

                    learningPathData = data;

                    renderProjects(data.projects);
                    renderSkills(data.current_skills, data.skill_gaps);
                    renderLearningPath(data.learning_path);

                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('contentArea').style.display = 'block';
                    document.getElementById('downloadBtn').style.display = 'inline-block';
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to generate learning path');
            }
        }

        function renderProjects(projects) {
            const container = document.getElementById('projectsList');
            
            if (projects.length === 0) {
                container.innerHTML = '<p style="color: #666;">Not assigned to any projects</p>';
                return;
            }

            container.innerHTML = projects.map(proj => `
                <div class="project-item">
                    <div class="project-name">${proj.project_name}</div>
                    <div class="project-desc">${proj.description || 'No description'}</div>
                </div>
            `).join('');
        }

        function renderSkills(currentSkills, gaps) {
            const currentContainer = document.getElementById('currentSkills');
            const gapsContainer = document.getElementById('skillGaps');

            if (currentSkills.length === 0) {
                currentContainer.innerHTML = '<p style="color: #666;">No skills recorded</p>';
            } else {
                currentContainer.innerHTML = currentSkills.map(skill => 
                    `<div class="skill-badge">${skill}</div>`
                ).join('');
            }

            gapsContainer.innerHTML = gaps.map(skill => 
                `<div class="skill-badge gap">${skill}</div>`
            ).join('');
        }

        function renderLearningPath(pathText) {
            const container = document.getElementById('learningPath');
            
            let html = '';
            const lines = pathText.split('\n');
            let inList = false;
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                
                if (!line) {
                    if (inList) {
                        html += '</ul>';
                        inList = false;
                    }
                    continue;
                }
                
                if (/^[0-9]+\.\s+[A-Z\s]+$/.test(line) || /^[A-Z\s]{10,}$/.test(line)) {
                    if (inList) {
                        html += '</ul>';
                        inList = false;
                    }
                    html += `<h3>${line}</h3>`;
                }
                else if (line.match(/^[A-Z][a-z]+(?:\s+[A-Z][a-z]+)*:/) || 
                         (line.match(/^[A-Z\s]{5,25}$/) && !line.includes('('))) {
                    if (inList) {
                        html += '</ul>';
                        inList = false;
                    }
                    html += `<h4>${line}</h4>`;
                }
                else if (line.startsWith('-') || line.startsWith('•') || line.match(/^\d+\./)) {
                    if (!inList) {
                        html += '<ul>';
                        inList = true;
                    }
                    const cleanLine = line.replace(/^[-•]\s*|\d+\.\s*/, '');
                    html += `<li>${cleanLine}</li>`;
                }
                else {
                    if (inList) {
                        html += '</ul>';
                        inList = false;
                    }
                    
                    if (line.match(/^Week\s+\d+/i) || line.match(/^Day\s+\d+/i)) {
                        html += `<div class="timeline-item">${line}</div>`;
                    }
                    else if (line.match(/course|tutorial|documentation|book|video|website/i)) {
                        html += `<div class="resource-box">${line}</div>`;
                    }
                    else {
                        html += `<p>${line}</p>`;
                    }
                }
            }
            
            if (inList) {
                html += '</ul>';
            }
            
            container.innerHTML = html;
        }

        function downloadPDF() {
            if (!learningPathData) {
                alert('No learning path data available');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPos = 20;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 20;
            const maxWidth = 170;

            // Helper function to add new page if needed
            function checkPageBreak(requiredSpace) {
                if (yPos + requiredSpace > pageHeight - margin) {
                    doc.addPage();
                    yPos = 20;
                    return true;
                }
                return false;
            }

            // Title
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('Learning Path Report', margin, yPos);
            yPos += 10;

            // Employee Info
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Employee: ${employeeName}`, margin, yPos);
            yPos += 7;
            doc.text(`ID: ${employeeId}`, margin, yPos);
            yPos += 7;
            doc.text(`Title: ${employeeTitle} | Department: ${employeeDept}`, margin, yPos);
            yPos += 15;

            // Projects Section
            checkPageBreak(30);
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Active Projects:', margin, yPos);
            yPos += 8;

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            learningPathData.projects.forEach(proj => {
                checkPageBreak(15);
                doc.text(`• ${proj.project_name}`, margin + 5, yPos);
                yPos += 6;
                if (proj.description) {
                    const descLines = doc.splitTextToSize(proj.description, maxWidth - 10);
                    descLines.forEach(line => {
                        checkPageBreak(6);
                        doc.text(line, margin + 10, yPos);
                        yPos += 5;
                    });
                }
                yPos += 3;
            });
            yPos += 10;

            // Skills Section
            checkPageBreak(30);
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Skills Overview:', margin, yPos);
            yPos += 8;

            // Current Skills
            doc.setFontSize(11);
            doc.text('Current Skills:', margin, yPos);
            yPos += 6;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const currentSkillsText = learningPathData.current_skills.join(', ') || 'None';
            const currentSkillsLines = doc.splitTextToSize(currentSkillsText, maxWidth - 5);
            currentSkillsLines.forEach(line => {
                checkPageBreak(6);
                doc.text(line, margin + 5, yPos);
                yPos += 5;
            });
            yPos += 8;

            // Skill Gaps
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('Skills to Learn:', margin, yPos);
            yPos += 6;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const skillGapsText = learningPathData.skill_gaps.join(', ');
            const skillGapsLines = doc.splitTextToSize(skillGapsText, maxWidth - 5);
            skillGapsLines.forEach(line => {
                checkPageBreak(6);
                doc.text(line, margin + 5, yPos);
                yPos += 5;
            });
            yPos += 15;

            // Learning Path Content
            checkPageBreak(30);
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Personalized Learning Path:', margin, yPos);
            yPos += 10;

            // Parse learning path text
            const lines = learningPathData.learning_path.split('\n');
            
            for (let line of lines) {
                line = line.trim();
                if (!line) {
                    yPos += 4;
                    continue;
                }

                checkPageBreak(15);

                // Main headings
                if (/^[0-9]+\.\s+[A-Z\s]+$/.test(line) || /^[A-Z\s]{10,}$/.test(line)) {
                    yPos += 5;
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    const headingLines = doc.splitTextToSize(line, maxWidth);
                    headingLines.forEach(hl => {
                        checkPageBreak(8);
                        doc.text(hl, margin, yPos);
                        yPos += 7;
                    });
                }
                // Subheadings
                else if (line.match(/^[A-Z][a-z]+(?:\s+[A-Z][a-z]+)*:/)) {
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    const subLines = doc.splitTextToSize(line, maxWidth);
                    subLines.forEach(sl => {
                        checkPageBreak(7);
                        doc.text(sl, margin, yPos);
                        yPos += 6;
                    });
                }
                // List items
                else if (line.startsWith('-') || line.startsWith('•') || line.match(/^\d+\./)) {
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    const cleanLine = line.replace(/^[-•]\s*|\d+\.\s*/, '');
                    const itemLines = doc.splitTextToSize('• ' + cleanLine, maxWidth - 5);
                    itemLines.forEach(il => {
                        checkPageBreak(6);
                        doc.text(il, margin + 5, yPos);
                        yPos += 5;
                    });
                }
                // Regular text
                else {
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    const textLines = doc.splitTextToSize(line, maxWidth);
                    textLines.forEach(tl => {
                        checkPageBreak(6);
                        doc.text(tl, margin, yPos);
                        yPos += 5;
                    });
                }
            }

            // Save PDF
            const filename = `LearningPath_${employeeId}_${employeeName.replace(/\s+/g, '_')}.pdf`;
            doc.save(filename);
        }

        window.addEventListener('DOMContentLoaded', loadLearningPath);
    </script>
</body>
</html>