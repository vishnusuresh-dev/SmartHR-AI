<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Employee Registration</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- Custom External CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

    <style>
        .alert-floating {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 350px;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .is-invalid {
            border-color: #dc3545 !important;
        }
        .is-valid {
            border-color: #198754 !important;
        }
        .validation-message {
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
    </style>

    <script>
        function addSkill() {
            const container = document.getElementById("skills-container");
            const row = document.createElement("div");
            row.classList.add("row", "g-3", "mt-2");

            row.innerHTML = `
                <div class="col-md-6">
                    <input type="text" name="skill_name[]" class="form-control input-style" placeholder="Skill Name">
                </div>
                <div class="col-md-6">
                    <input type="number" name="skill_exp[]" class="form-control input-style" placeholder="Experience (Years)">
                </div>
            `;

            container.appendChild(row);
        }

        // Real-time email validation
        async function validateEmail(email) {

            const emailInput = document.querySelector('input[name="email"]');
            const feedbackDiv = document.getElementById('email-feedback');

            if (!email) {
                feedbackDiv.innerHTML = "";
                emailInput.classList.remove('is-invalid', 'is-valid');
                return false;
            }

            // ✅ EMAIL PATTERN CHECK (ADD HERE)
            const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

            if (!emailPattern.test(email)) {
                emailInput.classList.add('is-invalid');
                emailInput.classList.remove('is-valid');
                feedbackDiv.innerHTML = `
                    <div class="text-danger validation-message">
                        <i class="fas fa-exclamation-circle"></i>
                        Wrong email pattern
                    </div>`;
                return false;
            }

            // ✅ Pattern correct → API call
            const response = await fetch('/api/validate-email', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ email: email })
            });

            const data = await response.json();

            if (data.exists) {
                emailInput.classList.add('is-invalid');
                emailInput.classList.remove('is-valid');
                feedbackDiv.innerHTML = `
                    <div class="text-danger validation-message">
                        <i class="fas fa-exclamation-circle"></i>
                        ${data.message}
                    </div>`;
                return false;
            } else {
                emailInput.classList.add('is-valid');
                emailInput.classList.remove('is-invalid');
                feedbackDiv.innerHTML = `
                    <div class="text-success validation-message">
                        <i class="fas fa-check-circle"></i>
                        Email is valid
                    </div>`;
                return true;
            }
        }

        // Real-time phone validation
        async function validatePhone(phone) {
            const phoneInput = document.querySelector('input[name="phone"]');
            const feedbackDiv = document.getElementById('phone-feedback');

            // ✅ Pattern check first (6–9 + 9 digits)
            const phonePattern = /^[6-9][0-9]{9}$/;
            if (!phonePattern.test(phone)) {
                phoneInput.classList.add('is-invalid');
                phoneInput.classList.remove('is-valid');
                feedbackDiv.innerHTML = `
                    <div class="text-danger validation-message">
                        <i class="fas fa-exclamation-circle"></i>
                        Wrong phone number pattern
                    </div>`;
                return false;
            }

            // ✅ If pattern correct → then check API
            const response = await fetch('/api/validate-phone', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ phone: phone })
            });

            const data = await response.json();

            if (data.exists) {
                phoneInput.classList.add('is-invalid');
                phoneInput.classList.remove('is-valid');
                feedbackDiv.innerHTML = `
                    <div class="text-danger validation-message">
                        <i class="fas fa-exclamation-circle"></i>
                        ${data.message}
                    </div>`;
                return false;
            } else {
                phoneInput.classList.add('is-valid');
                phoneInput.classList.remove('is-invalid');
                feedbackDiv.innerHTML = `
                    <div class="text-success validation-message">
                        <i class="fas fa-check-circle"></i>
                        Phone number is valid
                    </div>`;
                return true;
            }
        }

        // Debounce function to avoid too many API calls
        let emailTimeout, phoneTimeout;

        function debounceEmail(email) {
            clearTimeout(emailTimeout);
            emailTimeout = setTimeout(() => validateEmail(email), 500);
        }

        function debouncePhone(phone) {
            clearTimeout(phoneTimeout);
            phoneTimeout = setTimeout(() => validatePhone(phone), 500);
        }

        // Form submission validation
        async function validateForm(event) {
            const email = document.querySelector('input[name="email"]').value;
            const phone = document.querySelector('input[name="phone"]').value;
            
            const emailValid = await validateEmail(email);
            const phoneValid = await validatePhone(phone);
            
            if (emailValid === false || phoneValid === false) {
                event.preventDefault();
                showAlert('Please fix validation errors before submitting', 'danger');
                return false;
            }
            
            return true;
        }

        // Show floating alert
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show alert-floating`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'danger' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Auto-dismiss server alerts
        document.addEventListener('DOMContentLoaded', function() {
            const alerts = document.querySelectorAll('.alert:not(.alert-floating)');
            alerts.forEach(alert => {
                setTimeout(() => {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }, 5000);
            });
        });
    </script>

</head>
<body>

<div class="container my-5">
    <!-- Flash Messages from Server -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'danger' else 'success' if category == 'success' else 'warning' }} alert-dismissible fade show" role="alert">
                <i class="fas fa-{{ 'exclamation-triangle' if category == 'danger' else 'check-circle' if category == 'success' else 'info-circle' }}"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="form-card p-4 shadow-lg">

        <h2 class="text-center mb-4 title">Employee Registration Form</h2>

        <form action="/submit" method="POST" enctype="multipart/form-data" onsubmit="return validateForm(event)">

            <div class="row g-4">

                <div class="col-md-6">
                    <label class="form-label fw-bold">Full Name</label>
                    <input type="text" name="full_name" class="form-control input-style" required>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-bold">Email Address *</label>
                    <input type="email" 
                            name="email" 
                            class="form-control input-style" 
                            onkeyup="debounceEmail(this.value)"
                            required>
                    <div id="email-feedback"></div>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-bold">Password</label>
                    <input type="password" name="password" class="form-control input-style" required>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-bold">Date of Birth</label>
                    <input type="date" name="dob" class="form-control input-style" required>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-bold">Phone Number *</label>
                    <input type="text" 
                           name="phone" 
                           class="form-control input-style"
                           maxlength="10"
                            pattern="[6-9]{1}[0-9]{9}"
                           onkeyup="debouncePhone(this.value)"
                           required>
                    <div id="phone-feedback"></div>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-bold">Employee ID (Auto)</label>
                    <input type="text" name="employee_id" 
                           value="EMP{{ random_id }}" 
                           class="form-control input-style bg-light" readonly>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-bold">Department / Team</label>
                    <input type="text" name="department" class="form-control input-style" required>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-bold">Job Title / Role</label>
                    <input type="text" name="job_title" class="form-control input-style" required>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-bold">Total Experience (Years)</label>
                    <input type="number" 
                        name="total_exp" 
                        step="0.1" 
                        min="0" 
                        max="50"
                        placeholder="e.g., 2.5"
                        class="form-control input-style" 
                        required>
                </div>

            </div>

            <hr class="mt-4">

            <h5 class="fw-bold mb-3">Skills & Experience</h5>

            <div id="skills-container">
                <div class="row g-3">
                    <div class="col-md-6">
                        <input type="text" name="skill_name[]" class="form-control input-style" placeholder="Skill Name">
                    </div>
                    <div class="col-md-6">
                        <input type="number" name="skill_exp[]" class="form-control input-style" placeholder="Experience (Years)">
                    </div>
                </div>
            </div>

            <button type="button" class="btn btn-success mt-3" onclick="addSkill()">
                <i class="fa fa-plus"></i> Add Skill
            </button>

            <hr class="mt-4">

            <div class="row g-4">

                <div class="col-md-6">
                    <label class="form-label fw-bold">Upload Resume</label>
                    <input type="file" name="resume" accept=".pdf,.doc,.docx" class="form-control input-style" required>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-bold">Profile Picture</label>
                    <input type="file" name="profile_pic" accept="image/*" class="form-control input-style">
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-bold">Date of Joining</label>
                    <input type="date" name="joining_date" class="form-control input-style" required>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-bold">Employment Status</label>
                    <select name="status" class="form-select input-style">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>

                <div class="col-md-12">
                    <label class="form-label fw-bold">Reporting Manager</label>
                    <input type="text" name="manager" class="form-control input-style" required>
                </div>

            </div>

            <button class="btn btn-primary submit-btn mt-4 w-100">
                <i class="fas fa-paper-plane"></i> Submit Employee Details
            </button>

        </form>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>